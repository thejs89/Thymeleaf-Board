<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.thymeleaf.repository.PasswordResetRepo">

  <!-- 다음 시퀀스 조회 -->
  <select id="getNextPasswordResetSeq" resultType="Integer">
    SELECT NVL(MAX(seq) + 1, 1) AS seq
      FROM password_reset
  </select>

  <!-- 비밀번호 재설정 정보 저장 -->
  <insert id="insertPasswordReset">
    INSERT INTO password_reset 
                (seq
                ,email
                ,token
                ,exp_date
                ,used_yn
                ,reg_date
                ,reg_ip) 
         VALUES (#{seq}
                ,#{email}
                ,#{token}
                ,#{expDate}
                ,#{usedYn}
                ,#{regDate}
                ,#{regIp})
  </insert>

  <!-- 토큰으로 비밀번호 재설정 정보 조회 -->
  <select id="getPasswordResetByToken" resultType="passwordReset">
    SELECT seq
          ,email
          ,token
          ,exp_date as expDate
          ,used_yn as usedYn
          ,reg_date as regDate
          ,reg_ip as regIp
      FROM password_reset
     WHERE token = #{token}
       AND used_yn = false
  </select>

  <!-- 사용 완료 처리 -->
  <update id="updatePasswordResetUsed">
    UPDATE password_reset
       SET used_yn = true
     WHERE seq = #{seq}
  </update>

  <!-- 같은 이메일의 기존 미사용 토큰 무효화 -->
  <update id="invalidatePreviousTokens">
    UPDATE password_reset
       SET used_yn = true
     WHERE email = #{email}
       AND used_yn = false
  </update>

</mapper>

